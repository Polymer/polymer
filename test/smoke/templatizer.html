<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>Polymer - templatizer</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../src/properties/batched-effects.html">
  <link rel="import" href="../../src/attributes/attribute-to-from-property.html">
  <link rel="import" href="../../src/template/template-stamp.html">
  <link rel="import" href="../../src/events/gesture-event-listeners.html">
  <link rel="import" href="../../src/templatizer/templatizer.html">

</head>
<body>

  <script>
  (function() {

    var data = new Polymer.BatchedEffects();
    var templatizer = new Polymer.Templatizer();

    class XTemplatizer extends HTMLElement {

      constructor() {
        this.createdCallback();
      }

      createdCallback() {
        this.prop = 0;
      }

      connectedCallback() {
        this.attachedCallback();
      }

      attachedCallback() {
        data.flush(this);
        var template = this.querySelector('template');
        var self = this;
        var ctor = templatizer.templatize(template, {
          fwdHostPropToInstance: function(prop, value) {
            // this.inst[prop] = value;
            self.inst.forwardProperty(prop, value);
          },
          fwdInstancePropToHost: function(inst, prop, value) {
            console.log('instance prop changed:', prop, value);
          },
          instanceProps: {
            instProp: 'instProp'
          }
        });
        this.inst = new ctor(this);
        this.parentNode.insertBefore(this.inst.root, this.nextSibling);
      }

    }

    document.registerElement('x-templatizer', XTemplatizer);

  })();

  </script>

  <template id="x-host">
    <!-- TODO(kschaaf): dataHost (which templatizer currently relies on to get
         rootDataHost) not set correctly unless element is annotated -->
    <x-templatizer id="foo">
      host: <input value="{{prop::input}}">
      <template>
        <div on-tap="handleTap">from host: <input value="{{prop::input}}"></div>
        <div>{{compute(prop, instProp)}}</div>
        <div>instance: <input value="{{instProp::input}}"></div>
      </template>
    </x-templatizer>
  </template>


  <script>
  (function() {

    var data = new Polymer.BatchedEffects();

    var template = document.querySelector('template#x-host');

    class XHost extends HTMLElement {

      constructor() {
        this.createdCallback();
      }

      createdCallback() {
        data.prepare(this, function() {
          this.attachShadow({mode:'open'}).appendChild(data.stamp(this, template));
        });
        this.prop = 100;
      }

      connectedCallback() {
        this.attachedCallback();
      }

      attachedCallback() {
        data.flush(this);
      }

      compute(prop, instProp) {
        return 'computed: ' + prop + ' ' + instProp;
      }

      handleTap() {
        console.log('tapped');
      }

    }

    data.bindTemplate(XHost, template);
    document.registerElement('x-host', XHost);

  })();
  </script>

  <x-host></x-host>

</body>
</html>
