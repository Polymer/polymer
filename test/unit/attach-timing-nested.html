<!DOCTYPE html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../polymer.html">
  </head>
  <body>
  
  <dom-module id="x-b">
    <template>x-b</template>
    <script>
    var stream = [];
    HTMLImports.whenReady(function() {
      Polymer({
        is: 'x-b',
        properties: {
          foo: {value: 'foo', observer: '_fooChanged'}
        },
        attached: function() {
          stream.push({attached: this.is});
        },
        _fooChanged: function() {
          stream.push({changed: this.is});
        }
      });
    });
    </script>
  </dom-module>

  <dom-module id="x-a">
    <template>x-a: <x-b></x-b></template>
    <script>
      HTMLImports.whenReady(function() {
      Polymer({
        is: 'x-a',
        properties: {
          foo: {value: 'foo', observer: '_fooChanged'}
        },
        attached: function() {
          stream.push({attached: this.is});
        },
        _fooChanged: function() {
          stream.push({changed: this.is});
        }
      });
    });
    </script>
  </dom-module>
  
  
  <dom-module id="attached-element">
    <template>
      <style>
        :host {
          display: block;
        }
      </style>
      attached-element: <x-a></x-a>
    </template>

    <script>
    var registered;
    function registerTestElement() {
      if (!registered) {
        registered = true;
        Polymer({
          is: 'attached-element',
          properties: {
            foo: {value: 'foo', observer: '_fooChanged'}
          },
          attached: function() {
            stream.push({attached: this.is});
          },
          _fooChanged: function() {
            stream.push({changed: this.is});
          }
        });
      }
    };
    </script>
  </dom-module>


    <attached-element></attached-element>

    <script>
    suite('attached-timing-nested', function() {
      var el;
      setup(function() {
        registerTestElement();
        el = document.querySelector('attached-element');
        CustomElements.takeRecords();
      });

      test('attached and observer order', function() {
        if (CustomElements.useNative) {
          assert.deepEqual(stream, [
            {changed: 'x-b'},
            {changed: 'x-a'},
            {attached: 'x-a'},
            {attached: 'x-b'},
            {changed: 'attached-element'},
            {attached: 'attached-element'}
          ]);
        // Under polyfilled custom elements, attachedCallbacks are 
        // in dom tree order always.
        } else {
          assert.deepEqual(stream, [
            {changed: 'x-b'},
            {changed: 'x-a'},
            {changed: 'attached-element'},
            {attached: 'attached-element'},
            {attached: 'x-a'},
            {attached: 'x-b'}
          ]);
        }
      });
    
    });
    </script>
  </body>
</html>
