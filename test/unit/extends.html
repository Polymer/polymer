<!DOCTYPE html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="UTF-8">

  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../polymer.html">
</head>
<body>

<dom-module id="x-input">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-input',
      extends: 'input'
    })
  });
  </script>
</dom-module>

<dom-module id="x-extends-x-input">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extends-x-input',
      extends: 'x-input'
    })
  });
  </script>
</dom-module>

<dom-module id="x-base">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-base',
      method1Count: 0,
      method2Count: 0,
      tapCount: 0,
      propCount: 0,
      observerCount: 0,
      readyCount: 0,
      attachedCount: 0,
      detachedCount: 0,
      hostAttributes: {
        foo: true
      },
      properties: {
        prop: {
          value: true,
          observer: '_propChanged'
        },
        o: {
          value: 'hi'
        }
      },
      listeners: {
        tap: '_tap'
      },
      observers: [
        '_observer(o)'
      ],
      ready: function() {
        this.readyCount++;
      },
      attached: function() {
        this.attachedCount++;
      },
      detached: function() {
        this.detachedCount++;
      },
      method1: function() {
        this.method1Count++;
      },
      method2: function() {
        this.method2Count++;
      },
      _tap: function() {
        this.tapCount++;
      },
      _observer: function() {
        this.observerCount++;
      },
      _propChanged: function() {
        this.propCount++;
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-extend-1">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extend-1',
      extends: 'x-base'
    })
  });
  </script>
</dom-module>

<dom-module id="x-extend-2">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extend-2',
      extends: 'x-base',
      prop2Count: 0,
      observer2Count: 0,
      hostAttributes: {
        foo: 'foo',
        bar: 'bar'
      },
      properties: {
        prop2: {
          value: true,
          observer: '_prop2Changed'
        },
        o2: {
          value: 'hi'
        }
      },
      listeners: {
        tap: '_tap'
      },
      observers: [
        '_observer2(o2)'
      ],
      ready: function() {
        this.getPrototype('x-base').ready.call(this);
        this.readyCount++;
      },
      attached: function() {
        this.getPrototype('x-base').attached.call(this);
        this.attachedCount++;
      },
      detached: function() {
        this.getPrototype('x-base').detached.call(this);
        this.detachedCount++;
      },
      method1: function() {
        this.getPrototype('x-base').method1.call(this);
        this.method1Count++;
      },
      method2: function() {
        this.method2Count++;
      },
      _prop2Changed: function() {
        this.prop2Count++;
      },
      _observer2: function() {
        this.observer2Count++;
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-extend-3">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extend-3',
      extends: 'x-extend-2'
    })
  });
  </script>
</dom-module>

<dom-module id="x-extend-4">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extend-4',
      extends: 'x-extend-3'
    })
  });
  </script>
</dom-module>

<dom-module id="x-extend-5">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-extend-5',
      extends: 'x-extend-4',
      prop3Count: 0,
      observer3Count: 0,
      hostAttributes: {
        foo: 'foo2',
        bar: 'bar2',
        zug: 'zug'
      },
      properties: {
        prop3: {
          value: true,
          observer: '_prop3Changed'
        },
        o3: {
          value: 'hi'
        }
      },
      listeners: {
        tap: '_tap'
      },
      observers: [
        '_observer3(o2)'
      ],
      ready: function() {
        this.getPrototype('x-extend-4').ready.call(this);
        this.readyCount++;
      },
      attached: function() {
        this.getPrototype('x-extend-4').attached.call(this);
        this.attachedCount++;
      },
      detached: function() {
        this.getPrototype('x-extend-4').detached.call(this);
        this.detachedCount++;
      },
      method1: function() {
        this.getPrototype('x-extend-4').method1.call(this);
        this.method1Count++;
      },
      method2: function() {
        this.method2Count++;
      },
      _prop3Changed: function() {
        this.prop3Count++;
      },
      _observer3: function() {
        this.observer3Count++;
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-template">
  <template>
    <style>
      #container1 {
        border: 1px solid black;
      }
    </style>
    <div id="container1">{{prop1}}</div>
    <div id="container2">{{prop2}}</div>
  </template>
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-template',
      properties: {
        prop1: {
          value: 'prop1'
        }
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-template-1">
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-template-1',
      extends: 'x-template',
      properties: {
        prop2: {
          value: 'prop2'
        }
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-template-2">
  <template>
    <style>
      #container1, #container2 {
        border: 2px solid black;
      }
    </style>
    <div>
      <div id="container1">{{prop1}}</div>
      <div id="container2">{{prop2}}</div>
    </div>
  </template>
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-template-2',
      extends: 'x-template-1'
    })
  });
  </script>
</dom-module>

<dom-module id="x-template-3">
  <template>
    <div>throws</div>
  </template>
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-template-3',
      extends: 'x-template-2',
      _applyEffectValue: function(info, value) {
        try {
          Polymer.Base._applyEffectValue.call(this, info, value);
        } catch(err) {
          this.fails = err;
        }
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-template-4">
  <template>
    <style>
      .container {
        border: 1px solid orange;
      }
    </style>
    <div class="container"></div>
    <div id="container3">{{prop1}}</div>
  </template>
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'x-template-4',
      extends: 'x-template-2',

      _processTemplate: function(template) {
         var superTemplate = this.getPrototype('x-template-2')._template;
         var c = template.content.querySelector('.container');
         c.appendChild(superTemplate.content.cloneNode(true));
         return template;
      }

    })
  });
  </script>
</dom-module>

<dom-module id="x-behavior">
  <script>
  HTMLImports.whenReady(function() {
    var behavior = {
      method1Count: 0,
      method2Count: 0,
      tapCount: 0,
      propCount: 0,
      observerCount: 0,
      hostAttributes: {
        foo: true
      },
      properties: {
        prop: {
          value: true,
          observer: '_propChanged'
        },
        o: {
          value: 'hi'
        }
      },
      listeners: {
        tap: '_tap'
      },
      observers: [
        '_observer(o)'
      ],
      ready: function() {
        this.readyCount++;
      },
      attached: function() {
        this.attachedCount++;
      },
      detached: function() {
        this.detachedCount++;
      },
      method1: function() {
        this.method1Count++;
      },
      method2: function() {
        this.method2Count++;
      },
      _tap: function() {
        this.tapCount++;
      },
      _observer: function() {
        this.observerCount++;
      },
      _propChanged: function() {
        this.propCount++;
      }
    }

    Polymer({
      is: 'x-behavior',
      behaviors: [behavior],
      readyCount: 0,
      attachedCount: 0,
      detachedCount: 0,
      ready: function() {
        this.readyCount++;
      },
      attached: function() {
        this.attachedCount++;
      },
      detached: function() {
        this.detachedCount++;
      }
    })
  });
  </script>
</dom-module>

<dom-module id="x-behavior-1">
  <script>
  HTMLImports.whenReady(function() {

    Polymer({
      is: 'x-behavior-1',
      extends: 'x-behavior'
    })
  });
  </script>
</dom-module>

<dom-module id="x-behavior-2">
  <script>
  HTMLImports.whenReady(function() {

    var behavior = {
      prop2Count: 0,
      observer2Count: 0,
      hostAttributes: {
        bar: true
      },
      properties: {
        prop2: {
          value: true,
          observer: '_prop2Changed'
        },
        o2: {
          value: 'hi'
        }
      },
      listeners: {
        tap: '_tap'
      },
      observers: [
        '_observer2(o)'
      ],
      ready: function() {
        this.readyCount++;
      },
      attached: function() {
        this.attachedCount++;
      },
      detached: function() {
        this.detachedCount++;
      },
      _observer2: function() {
        this.observer2Count++;
      },
      _prop2Changed: function() {
        this.prop2Count++;
      }
    }

    Polymer({
      is: 'x-behavior-2',
      extends: 'x-behavior-1',
      behaviors: [behavior]
    })
  });
  </script>
</dom-module>

<dom-module id="x-behavior-3">
  <script>
  HTMLImports.whenReady(function() {

    Polymer({
      is: 'x-behavior-3',
      extends: 'x-behavior-2',
      hostAttributes: {
        zug: true
      },
      ready: function() {
        this.getPrototype('x-behavior-2').ready.call(this);
        this.readyCount++;
      },
      attached: function() {
      },
      detached: function() {
      }
    })
  });
  </script>
</dom-module>

<script>

  function assertComputed(element, value, pseudo) {
    var name = 'border-top-width';
    var computed = element.getComputedStyleValue && !pseudo ?
      element.getComputedStyleValue(name) :
      getComputedStyle(element, pseudo)[name];
    assert.equal(computed, value, 'computed style incorrect');
  }

  suite('Extends', function() {

    test('native extends', function() {
      var e = document.createElement('input', 'x-input');
      assert.isTrue(Polymer.isInstance(e));
      assert.equal(e.localName, 'input');
    });

    test('extend native extends', function() {
      var e = document.createElement('input', 'x-extends-x-input');
      assert.isTrue(Polymer.isInstance(e));
      assert.equal(e.localName, 'input');
    });

    test('base element properties/methods', function() {
      var e = document.createElement('x-base');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.readyCount, 1);
      assert.equal(e.attachedCount, 1);
      assert.equal(e.detachedCount, 1);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('extended element with no overrides', function() {
      var e = document.createElement('x-extend-1');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.readyCount, 1);
      assert.equal(e.attachedCount, 1);
      assert.equal(e.detachedCount, 1);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('extended element with overrides', function() {
      var e = document.createElement('x-extend-2');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), 'foo');
      assert.equal(e.getAttribute('bar'), 'bar');
      assert.equal(e.readyCount, 2);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 2);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('extended element with overrides extended', function() {
      var e = document.createElement('x-extend-3');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), 'foo');
      assert.equal(e.getAttribute('bar'), 'bar');
      assert.equal(e.readyCount, 2);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 2);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('extended element with overrides extended x2', function() {
      var e = document.createElement('x-extend-4');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), 'foo');
      assert.equal(e.getAttribute('bar'), 'bar');
      assert.equal(e.readyCount, 2);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 2);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('extended element with overrides extended x2 + overrides', function() {
      var e = document.createElement('x-extend-5');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), 'foo2');
      assert.equal(e.getAttribute('bar'), 'bar2');
      assert.equal(e.getAttribute('zug'), 'zug');
      assert.equal(e.readyCount, 3);
      assert.equal(e.attachedCount, 3);
      assert.equal(e.detachedCount, 3);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      assert.equal(e.prop3Count, 1);
      assert.equal(e.observer3Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 3);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('element with template', function() {
      var e = document.createElement('x-template');
      document.body.appendChild(e);
      assert.ok(e.$.container1);
      assert.ok(e.$.container2);
      assertComputed(e.$.container1, '1px');
      assert.equal(e.$.container1.textContent, 'prop1');
      document.body.removeChild(e);
    });

    test('extended element without template uses super template', function() {
      var e = document.createElement('x-template-1');
      document.body.appendChild(e);
      assert.ok(e.$.container1);
      assert.equal(e.$.container1.textContent, 'prop1');
      assert.ok(e.$.container2);
      assert.equal(e.$.container2.textContent, 'prop2');
      assertComputed(e.$.container1, '1px');
      document.body.removeChild(e);
    });

    test('extended element uses own template', function() {
      var e = document.createElement('x-template-2');
      document.body.appendChild(e);
      assert.ok(e.$.container1);
      assert.equal(e.$.container1.textContent, 'prop1');
      assert.ok(e.$.container2);
      assert.equal(e.$.container2.textContent, 'prop2');
      assertComputed(e.$.container1, '2px');
      assertComputed(e.$.container2, '2px');
      document.body.removeChild(e);
    });

    test('extended element with own template throws if super properties are not present', function() {
      var e = document.createElement('x-template-3');
      assert.ok(e.fails);
    });

    test('extended element can add super class template to its template', function() {
      var e = document.createElement('x-template-4');
      assert.ok(e.$.container1);
      assert.equal(e.$.container1.textContent, 'prop1');
      assert.ok(e.$.container2);
      assert.equal(e.$.container2.textContent, 'prop2');
      assert.ok(e.$.container3);
      assert.equal(e.$.container3.textContent, 'prop1');
    });


    test('element with behavior', function() {
      var e = document.createElement('x-behavior');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.readyCount, 2);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('element extended from base element with behavior', function() {
      var e = document.createElement('x-behavior-1');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.readyCount, 2);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('element with behavior extended from base element with behavior', function() {
      var e = document.createElement('x-behavior-2');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.getAttribute('bar'), '');
      assert.equal(e.readyCount, 3);
      assert.equal(e.attachedCount, 3);
      assert.equal(e.detachedCount, 3);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

    test('element overrides extended from base element with behavior', function() {
      var e = document.createElement('x-behavior-3');
      document.body.appendChild(e);
      CustomElements.takeRecords();
      document.body.removeChild(e);
      CustomElements.takeRecords();
      assert.equal(e.getAttribute('foo'), '');
      assert.equal(e.getAttribute('bar'), '');
      assert.equal(e.getAttribute('zug'), '');
      assert.equal(e.readyCount, 4);
      assert.equal(e.attachedCount, 2);
      assert.equal(e.detachedCount, 2);
      assert.equal(e.propCount, 1);
      assert.equal(e.observerCount, 1);
      assert.equal(e.prop2Count, 1);
      assert.equal(e.observer2Count, 1);
      e.fire('tap');
      assert.equal(e.tapCount, 1);
      e.method1();
      assert.equal(e.method1Count, 1);
      e.method2();
      assert.equal(e.method2Count, 1);
    });

  });
</script>

</body>
</html>
