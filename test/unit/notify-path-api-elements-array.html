
<dom-module id="x-listing">
  <template>
    <h3 id="title">{{businessobject.title}}</h3>
    <ul id="list">
      <template is="dom-repeat" items="{{businessobject.alist}}">
        <li>{{item.content}}</li>
      </template>
    </ul>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'x-listing',
    properties: {
      businessobject: {
        type: Object
      }
    },
    observers: [
      'listSpliced(businessobject.alist.splices)'
    ],
    ready: function() {
      console.log('ready');
    },
    listSpliced: function(c) {
      if (typeof c === 'undefined') {
        console.warn('Splices observe got undefined change record');
      } else {
        console.log('Got splices', JSON.stringify(c));
      }
    }
  });
</script>

<script>
suite('notifyPath slices external', function() {

  // See https://github.com/Polymer/web-component-tester/issues/175 why we do this
  var wait = 50;

  var el;

  setup(function() {
    el = document.createElement('x-listing');
    document.body.appendChild(el);
  });

  teardown(function() {
    document.body.removeChild(el);
  });

  test('array initial content', function(done) {
    var bo = {
      title: 'Test list',
      alist: [{content: 'Item 1'}]
    };
    el.set('businessobject', bo);

    window.setTimeout(function() {
      assert.match(el.innerHTML, /Item 1/);
      done();
      // to get a console.log of a real splices notification
      el.push('businessobject.alist', {content: 'Item 2'});
    }, wait);
  });

  test('array push', function(done) {
    var bo = {
      title: 'Test list',
      alist: [{content: 'Item 1'}]
    };
    el.set('businessobject', bo);
    bo.alist.push({content: 'Item 2'});

    window.setTimeout(function() {
      assert.notMatch(el.innerHTML, /Item 2/);

      el.notifyPath('businessobject.alist.splices', {
        keySplices:[{
          index: 1,
          removed: [],
          removedItems: [],
          added: [1]
        }],
        indexSplices:[{
          index: 1,
          addedCount: 1,
          removed: [],
          object: bo.alist,
          type: 'splice'
        }]
      });
    }, wait);

    // The splices notification is insufficient to trigger render, and the below must run after a wait
    window.setTimeout(function() {
      el.notifyPath('businessobject.alist.1', bo.alist[1]);
    }, wait * 2);

    window.setTimeout(function() {
      assert.match(el.innerHTML, /Item 2/);
      done();
    }, wait * 3);
  });

});
</script>
