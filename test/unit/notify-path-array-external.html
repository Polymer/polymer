<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../polymer.html">
<body>

<!-- this first listonly part is only to establish a way of testing these things -->

<dom-module id="x-listonly">
  <template>
    <ul>
      <template is="dom-repeat" items="{{alist}}">
        <li>{{item.content}}</li>
      </template>
    </ul>
  </template>
  <script>
    Polymer({
      is: 'x-listonly',
      properties: {
        alist: {
          type: Array,
          value: [{content: 'Item X'}]
        }
      }
    });
  </script>
</dom-module>

<div id="list1">
  <x-listonly></x-listonly>
</div>

<script>
  suite('dom-repeat Array property', function() {

    var wait = 50;

    test('render at createElement', function(done) {
      var el = document.createElement('x-listonly');

      window.setTimeout(function() {
        assert.match(el.$$('ul').innerHTML, /Item X/, 'Should render list on element creation');
        done();
      }, wait);
    });

    test('Render to body above test suite', function() {
      var parent = document.querySelector('#list1');

      assert.match(parent.innerHTML, /Item X/);
    });

    test('Modify list using Polymer API', function(done) {
      var el = document.querySelector('x-listonly');
      el.push('alist', {content: 'Item Y'});

      window.setTimeout(function() {
        assert.match(el.innerHTML, /Item X/);
        assert.match(el.innerHTML, /Item Y/);
        done();
      }, wait);
    });

    test('New list to existing element', function(done) {
      var el = document.querySelector('x-listonly');
      el.set('alist', [{content: 'Item 1'}, {content: 'Item 2'}]);

      window.setTimeout(function() {
        assert.notMatch(el.innerHTML, /Item X/);
        assert.match(el.innerHTML, /Item 1/);
        assert.match(el.innerHTML, /Item 2/);
        done();
      }, wait);
    });

  });
</script>

<!-- the notifyPath part -->

<dom-module id="x-listing">
  <template>
    <h3 id="title">{{businessobject.title}}</h3>
    <ul id="list">
      <template is="dom-repeat" items="{{businessobject.alist}}">
        <li>{{item.content}}</li>
      </template>
    </ul>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'x-listing',
    properties: {
      businessobject: {
        type: Object
      }
    },
    observers: [
      'listSpliced(businessobject.alist.splices)'
    ],
    ready: function() {
      console.log('ready');
    },
    listSpliced: function(c) {
      console.log('list change', JSON.stringify(c));
    }
  });
</script>

<script>
suite('notifyPath slices external', function() {

  var wait = 50;

  var el;

  setup(function() {
    el = document.createElement('x-listing');
    document.body.appendChild(el);
  });

  teardown(function() {
    document.body.removeChild(el);
  });

  test('array initial content', function(done) {
    var bo = {
      title: 'Test list',
      alist: [{content: 'Item 1'}]
    };
    el.set('businessobject', bo);

    window.setTimeout(function() {
      assert.match(el.innerHTML, /Item 1/);
      done();
      // to get a console.log of a real splices notification
      el.push('businessobject.alist', {content: 'Item 2'});
    }, wait);
  });

  test('array push', function(done) {
    var bo = {
      title: 'Test list',
      alist: [{content: 'Item 1'}]
    };
    el.set('businessobject', bo);
    bo.alist.push({content: 'Item 2'});

    window.setTimeout(function() {
      assert.match(el.innerHTML, /Item 2/);
      done();
    }, wait * 3);
  });

});
</script>
