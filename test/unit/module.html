<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="utf-8">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../src/lib/module.html">
  <link rel="import" href="../assets/modules/one.html">
  <link rel="import" href="../assets/modules/two.html">
</head>
<body>

<script>

  suite('define()', function() {

    beforeEach(function() {
      for (var key in define._modules) {
        if (/\/assets\/modules\//.test(key)) continue;
        delete define._modules[key];
      }

      define('a', function() { return 'module A'; });
      define('b', function() { return 'module B'; });
    });

    test('supports anonymous modules', function(done) {
      define(['a'], function(a) {
        assert.equal(a, 'module A');
        done();
      });
    });

    test('supports modules with dependencies', function(done) {
      define('c', ['a'], function(a) {
        assert.equal(a, 'module A');
        return 'module C';
      });

      define(['c'], function(c) {
        assert.equal(c, 'module C');
        done();
      });
    });

    test('passes dependencies in order', function(done) {
      define('c', ['b', 'a'], function(b, a) {
        assert.equal(b, 'module B');
        assert.equal(a, 'module A');
        return 'module C';
      });

      define(['c'], function(c) {
        assert.equal(c, 'module C');
        done();
      });
    });

    test('allows modules that export nothing', function(done) {
      define('c', function() {});

      define(['c'], function(c) {
        assert.equal(c, undefined);
        done();
      });
    });

    test('throws if the last argument is not a function', function() {
      assert.throw(function() {
        define('a', ['b']);
      }, TypeError, /function/i);
    });

    test('throws if a dependency is missing', function() {
      assert.throw(function() {
        define('c', ['zzz'], function(z) {});
      }, ReferenceError, /"zzz".*loaded/i);
    });

    test('throws if a module has been redefined', function() {
      assert.throw(function() {
        define('a', function() {});
      }, Error, /"a".*defined/i);
    });

    suite('relative dependencies', function() {

      test('loads modules relative to the current', function(done) {
        define(['../assets/modules/one.html'], function(one) {
          assert.equal(one, 'module 1');
          done();
        });
      });

      test('loads relative modules transitively', function(done) {
        define(['../assets/modules/two.html'], function(two) {
          assert.equal(two.one,   'module 1');
          assert.equal(two.me,    'module 2');
          assert.equal(two.three, 'module 3');
          done();
        });
      });

    });

  });

</script>
</body>
</html>
