<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="g-selector" attributes="selected" handlers="click: clickHandler">
  <link rel="components" href="g-component.html">
  <link rel="components" href="g-selection.html">
  <template>
    <content id="items" select="*"></content>
  </template>
  <script>
    this.component({
      created: function() {
        var s = this.selection = document.createElement("g-selection");
        s.addEventListener("select", this.select.bind(this));
        s.addEventListener("deselect", this.deselect.bind(this));
        s.multi = this.hasAttribute('multi');
        this.selectedAttributeChanged();
      },
      prototype: {
        getItems: function() {
          return this.$.items.distributedNodes;
        },
        indexOfSelected: function(inSelected) {
          var items = this.getItems();
          for (var i=0, c; c=items[i]; i++) {
            if (c.value && c.value == inSelected) {
              return i;
            }
          }
          return inSelected;
        },
        getSelectedItem: function() {
          return (this.getItems())[this.indexOfSelected(this.selected)];
        },
        selectedAttributeChanged: function() {
          var s = this.getSelectedItem();
          if (s != null) {
            this.selection.select(s);
          }
        },
        select: function(e) {
          e.detail.item.classList.add('selected');
        },
        deselect: function(e) {
          e.detail.item.classList.remove('selected');
        },
        clickHandler: function(evt) {
          var n = evt.target;
          while (n && n != this) {
            var i = this.indexOfItem(n);
            if (i != undefined) {
              this.selected = n.value || i;
              break;
            }
            n = n.parentNode;
          }
        },
        indexOfItem: function(inItem) {
          for (var i=0, items=this.getItems(), c; c=items[i]; i++) {
            if (c == inItem) {
              return i;
            }
          }
        }
      }
    });
  </script>
</element>
