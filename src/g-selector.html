<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="g-selector" attributes="selected, multi" handlers="click: clickHandler">
  <link rel="components" href="g-component.html">
  <link rel="components" href="g-selection.html">
  <template>
    <g-selection id="selection" on-select="selectionSelect" on-deselect="selectionDeselect"></g-selection>
    <content id="items"></content>
  </template>
  <script>
    this.component({
      prototype: {
        multiChanged: function() {
          this.$.selection.multi = this.multi;
        },
        getItems: function() {
          // TODO(sjmiles): distributedNodes not implemented natively yet
          // this.childNodes is LightDOM fallback which works unless we
          // are composited (in that case childNodes = <content>, and 
          // distributeNodes is necessary to find the actual distributions)
          return this.$.items.getDistributedNodes() || 
            Array.prototype.slice.call(this.childNodes, 0);
        },
        _valueToIndex: function(inValue) {
          // find an item with value == inValue and return it's index
          var items = this.getItems();
          for (var i=0, c; c=items[i]; i++) {
            if (c.value && c.value == inValue) {
              return i;
            }
          }
          // if no item found, the value is an index itself
          return inValue;
        },
        selectedChanged: function() {
          // remember that this.selected is an attribute-property,
          // it's for i/o, not for internal state tracking
          var item = this.getItems()[this._valueToIndex(this.selected)];
          if (item) {
            this.$.selection.select(item);
          }
        },
        // events fired from <g-selection> object
        selectionSelect: function(inEvent) {
          inEvent.detail.item.classList.add('selected');
        },
        selectionDeselect: function(inEvent) {
          inEvent.detail.item.classList.remove('selected');
        },
        // event fired from host
        clickHandler: function(evt) {
          var items = this.getItems();
          var i = this.utils.findDistributedTarget(evt.target, items);
          if (i >= 0) {
            this.selected = items[i].value || i;
          }
        }
      }
    });
  </script>
</element>
