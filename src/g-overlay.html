<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="g-overlay" attributes="showing, timeout">
<link rel="components" href="g-component.html">
<template>
	<style scoped>
		@host {
			position: absolute;
			z-index: 10;
		}
	</style>
	<content></content>
</template>
<script>
  this.component({
    shadowRootCreated: function() {
      this.hidden = true;
    },
    prototype: {
      timeout: 1000,
      showingChanged: function() {
        this.animateShowing();
        webkitRequestAnimationFrame(this.fireShowingChange.bind(this));
      },
      dispatch: function(inName, inDetail) {
        this.dispatchEvent(new CustomEvent(inName, {
          bubbles: true,
          detail: inDetail
        }));
      },
      fireShowingChange: function() {
        this.dispatch("showingChange", {
          showing: this.showing,
          rect: this.getBoundingClientRect()
        });
      },
      animateShowing: function() {
        this.hidden = false;
        webkitRequestAnimationFrame(function() {
          var setBooleanAttribute = function(inNode, inName, inValue) {
            inNode[inValue ? "setAttribute" : "removeAttribute"](inName, "");
          };
          setBooleanAttribute(this, "opening", this.showing);
          setBooleanAttribute(this, "closing", !this.showing);
          this.unlisten();
          this.listen();
        }.bind(this));
      },
      listen: function() {
        this.animationListener = this.finishAnimate.bind(this);
        this.addEventListener("webkitAnimationEnd", this.animationListener);
        this.addEventListener("webkitTransitionEnd", this.animationListener);
        // always finish animation within timeout
        this.jobId = this.utils.job(this.jobId, this.animationListener, this.timeout);
      },
      finishAnimate: function() {
        if (!this.showing) {
          this.hidden = true;
          this.classList.remove(this.hideClass);
        }
        this.unlisten();
      },
      unlisten: function() {
        this.removeEventListener("webkitAnimationEnd", this.animationListener);
        this.removeEventListener("webkitTransitionEnd", this.animationListener);
        this.utils.job.stop(this.jobId);
      }
    }
  });
</script>
</element>