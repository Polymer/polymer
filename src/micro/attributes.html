<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../lib/case-map.html">

<script>

  Polymer.Base.addFeature({

    /**
     * Static attributes applied to all instances of an element.
     *
     * If a custom element needs HTML attributes set on it during creation,
     * these may be declared in a `hostAttributes` property on the prototype.
     * This property is an object where keys match the attribute name, and
     * values are converted into attribute values.
     *
     * If an attribute value is `true`, the attribute will be applied with no
     * value, otherwise the value will be serialized to a string via
     * `serialize()`.
     *
     * For example:
     *
     *     Polymer({
     *       is: 'x-thing',
     *       hostAttributes: {
     *         tabindex: 0,
     *         role: 'button',
     *         'aria-disabled': true
     *       }
     *     });
     *
     * Results in:
     *
     *     <x-thing tabindex="0" role="button" aria-disabled></x-thing>
     *
     */
    hostAttributes: {},

    _marshalAttributes: function() {
      this._takeAttributes();
      this._installHostAttributes(this.hostAttributes);
    },

    _installHostAttributes: function(attributes) {
      if (attributes) {
        this.applyAttributes(this, attributes);
      }
    },

    applyAttributes: function(node, attr$) {
      for (var n in attr$) {
        this.serializeValueToAttribute(attr$[n], n, this);
      }
    },

    _takeAttributes: function() {
      this._takeAttributesToModel(this);
    },

    _takeAttributesToModel: function(model) {
      for (var propName in this.properties) {
        var attrName = Polymer.CaseMap.camelToDashCase(propName);
        if (this.hasAttribute(attrName)) {
          var val = this.getAttribute(attrName);
          var type = this.getPropertyType(propName);
          model[propName] = this.deserialize(val, type);
        }
      }
    },

    setAttributeToProperty: function(model, attrName) {
      // Don't deserialize back to property if currently reflecting
      if (!this._serializing) {
        var propName = Polymer.CaseMap.dashToCamelCase(attrName);
        if (propName in this.properties) {
          var type = this.getPropertyType(propName);
          var val = this.getAttribute(attrName);
          model[propName] = this.deserialize(val, type);
        }
      }
    },

    _serializing: false,
    reflectPropertyToAttribute: function(name) {
      this._serializing = true;
      this.serializeValueToAttribute(this[name],
        Polymer.CaseMap.camelToDashCase(name));
      this._serializing = false;
    },

    serializeValueToAttribute: function(value, attribute, node) {
      var str = this.serialize(value);
      (node || this)
        [str === undefined ? 'removeAttribute' : 'setAttribute']
          (attribute, str);
    },

    /**
     * @param {string} value A serialized value to process.
     * @param {function(new:*)} A native class for the primitive value to try to
     *     parse `value` as (e.g. `Number`, `Boolean`, `Object`, etc).
     * @return {*} The deserialized value, or `null`.
     * @see #serialize
     */
    deserialize: function(value, type) {
      switch (type) {
        case Number:
          value = Number(value);
          break;

        case Boolean:
          value = (value !== null);
          break;

        case Object:
          try {
            value = JSON.parse(value);
          } catch(x) {
            // allow non-JSON literals like Strings and Numbers
          }
          break;

        case Array:
          try {
            value = JSON.parse(value);
          } catch(x) {
            value = null;
            console.warn('Polymer::Attributes: couldn`t deserialize', value, 'as JSON:', x);
          }
          break;

        case Date:
          value = new Date(value);
          break;

        case String:
        default:
          break;
      }
      return value;
    },

    /**
     * @param {*} value The value to serialize.
     * @return {string} A string representation of `value`, appropriate for use
     *     in attributes.
     * @see #deserialize
     */
    serialize: function(value) {
      switch (typeof value) {
        case 'boolean':
          return value ? '' : undefined;

        case 'object':
          if (value instanceof Date) {
            return value;
          } else if (value) {
            try {
              return JSON.stringify(value);
            } catch(x) {
              console.warn('Polymer::Attributes: couldn`t serialize', value, 'as JSON:', x);
              return '';
            }
          }

        default:
          return value != null ? value : undefined;
      }
    }

  });

</script>
