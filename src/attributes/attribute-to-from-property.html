<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../utils/boot.html">
<link rel="import" href="../utils/case-map.html">
<link rel="import" href="attribute-to-property.html">

<script>
(function() {

  'use strict';

  // 'import'
  var caseMap = Polymer.CaseMap;

  class AttributeToFromProperty extends Polymer.AttributeToProperty {

    ensureAttributes(node, attributes) {
      for (var a in attributes) {
        this.ensureAttribute(node, a, attributes[a]);
      } 
    }

    /* apply attribute value to node but avoid overriding an existing value */
    ensureAttribute(node, attr, value) {
      if (!node.hasAttribute(attr)) {
        node._serializing = true;
        this.valueToAttribute(node, value, attr);
        node._serializing = false;
      }
    }

    /**
     * Serializes a property to its associated attribute.
     *
     * @method propertyToAttribute
     * @param {string} property Property name to reflect.
     * @param {*=} attribute Attribute name to reflect.
     * @param {*=} value Property value to refect.
     */
    // TODO(sorvell): only needed by property setters
    propertyToAttribute(node, property, attribute, value) {
      node._serializing = true;
      value = (value === undefined) ? node[property] : value;
      this.valueToAttribute(node, value,
        attribute || caseMap.camelToDashCase(property));
      node._serializing = false;
    }

    /**
     * Sets a typed value to an HTML attribute on a node.
     *
     * This method calls the `serialize` method to convert the typed
     * value to a string.  If the `serialize` method returns `undefined`,
     * the attribute will be removed (this is the default for boolean
     * type `false`).
     *
     * @method valueToAttribute
     * @param {Element=} node Element to set attribute to.
     * @param {*} value Value to serialize.
     * @param {string} attribute Attribute name to serialize to.

     */
    valueToAttribute(node, value, attribute) {
      var str = this.serialize(value);
      if (str === undefined) {
        node.removeAttribute(attribute);
      } else {
        node.setAttribute(attribute, str);
      }
    }

    /**
     * Converts a typed value to a string.
     *
     * This method is called by Polymer when setting JS property values to
     * HTML attributes.  Users may override this method on Polymer element
     * prototypes to provide serialization for custom types.
     *
     * @method serialize
     * @param {*} value Property value to serialize.
     * @return {string} String serialized from the provided property value.
     */
    serialize(value) {
      /* eslint-disable no-fallthrough */
      switch (typeof value) {
        case 'boolean':
          return value ? '' : undefined;

        case 'object':
          if (value instanceof Date) {
            return value;
          } else if (value) {
            try {
              return JSON.stringify(value);
            } catch(x) {
              return '';
            }
          }

        default:
          return value != null ? value : undefined;
      }
    }
    /* eslint-enable no-fallthrough */
  }

  // export
  Polymer.AttributeToFromProperty = AttributeToFromProperty;

})();
</script>
