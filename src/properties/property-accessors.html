<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../utils/case-map.html">

<script>
(function() {

  'use strict';

  class PropertyAccessors {

    createAccessor(model, property, readOnly) {
      model = this.getModel(model);
      this._saveAccessorValue(model, property);
      var lib = this;
      Object.defineProperty(model, property, {
        get: function() {
          return this.__data && this.__data[property];
        },
        set: readOnly ? function() { } : function(value) {
          lib.setProperty(this, property, value);
        }
      });
    }

    _saveAccessorValue(model, property) {
      if (model.hasOwnProperty(property)) {
        if (!model.__dataProto) {
          model.__dataProto = {};
        } else if (!model.hasOwnProperty('__dataProto')) {
          model.__dataProto = Object.create(model.__dataProto);
        }
        model.__dataProto[property] = model[property];
      }
    }

    getModel(model) {
      return typeof model == 'function' ? model.prototype : model;
    }

    createAcessorsForAttributes(model, attrs) {
      var attrs = attrs || model.observedAttributes;
      if (attrs) {
        for (var i=0; i<attrs.length; i++) {
          var property = Polymer.CaseMap.dashToCamelCase(attrs[i]);
          this.createAccessor(model, property);
        }
      }
    }

    setProperty(inst, property, value) {
      if (this.setPendingProperty(inst, property, value)) {
        this.invalidate(inst);
      }
    }

    setPendingProperty(inst, property, value) {
      if (!inst.__data) {
        inst.__data = {};
      }
      var old = inst.__data[property];
      if (this.shouldPropChange(value, old)) {
        if (!inst.__dataPending) {
          inst.__dataPending = {};
          inst.__dataOld = {};
        }
        // Ensure old is captured from the last turn
        if (!(property in inst.__dataOld)) {
          inst.__dataOld[property] = old;
        }
        inst.__data[property] = value;
        inst.__dataPending[property] = value;
        return true;
      }
    }

    invalidate(inst) {
      if (!inst.__dataInvalid) {
        inst.__dataInvalid = true;
        var self = this;
        Promise.resolve().then(function() {
          if (inst.__dataInvalid) {
            inst.__dataInvalid = false;
            self.flush(inst);
          }
        });
      }
    }

    flush(inst) {
      var oldProps = inst.__dataOld;
      var changedProps = inst.__dataPending;
      inst.__dataPending = null;
      if (inst.propertiesChanged) {
        inst.propertiesChanged(inst.__data, changedProps, oldProps);
      } else {
        this.propertiesChanged(inst, inst.__data, changedProps, oldProps);
      }
    }

    propertiesChanged(inst, currentProps, changedProps, oldProps) {
    }

    shouldPropChange(value, old) {
      return ((old !== value && (old === old || value === value)) ||
        (typeof value == 'object'));
    }

    extendWithAPI(superClass) {
      var klass = class extends superClass {
        propertiesChanged(currentProps, changedProps, oldProps) {
          this.constructor.data.propertiesChanged(this,
            currentProps, changedProps, oldProps);
        }
      }
      // Install data library on constructor
      klass.data = this;
      return klass;
    }

  }

  // export
  Polymer.PropertyAccessors = PropertyAccessors;

})();
</script>
